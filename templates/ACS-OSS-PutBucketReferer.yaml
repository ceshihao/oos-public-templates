FormatVersion: OOS-2019-06-01
Description:
  en: 'Put the bucket referer.'
  zh-cn: 设置存储空间防盗链。
  name-en: ACS-OSS-PutBucketReferer
  name-zh-cn: 设置存储空间防盗链
  categories:
    - security
Parameters:
  regionId:
    Type: String
    Description: The id of target region.
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  bucketName:
    Description:
      name-en: The  OSS bucket names.
      name-zh-cn: OSS bucket 名称。
    Type: String
  allowEmptyReferer:
    Description:
      name-en: Specify whether to allow access to requests whose Referer field is empty.
      name-zh-cn: 指定是否允许Referer字段为空的请求访问。
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
  refererList:
    Description:
      en: (for example:[http://www.aliyun.com, https://www.aliyun.com]).
      zh-cn: （例如：[http://www.aliyun.com, https://www.aliyun.com]）。
      name-en: Save Referer access whitelist URL
      name-zh-cn: 保存Referer访问白名单的网址
    Type: List
    Default: []
  OOSAssumeRole:
    Description:
      name-en: The RAM role to be assumed by OOS.
      name-zh-cn: OOS扮演的RAM角色。
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: convertXmlParameters
    Action: 'ACS::ECS::SMCConversionConstantByJqScript'
    Description:
      name-en: Automatically make bucket referer configuration.
      name-zh-cn: 自动生成存储空间防盗链规则。
    Properties:
      parameter: '{{ refererList }}'
      jqScript:
        - '. [] | split("[") | join("") | split("]") | join("") | split("\"") | join("") |split(",") | map(. | .="<Referer>"+.+"</Referer>") as $item| $item | join("") as $itemList | "<RefererConfiguration><AllowEmptyReferer>{{ allowEmptyReferer }}</AllowEmptyReferer><RefererList>"+$itemList+"</RefererList>" as $refererList |$refererList'
        - .
    Outputs:
      xmlValues:
        Type: String
        ValueSelector: firstValue
  - Name: putBucketReferer
    Action: 'ACS::ExecuteAPI'
    Description:
      name-en: 'Enable the bucket referer.'
      name-zh-cn: 开启存储空间防盗链。
    Properties:
      Service: OSS
      API: PutBucketReferer
      Method: PUT
      URI: '?referer'
      Headers:
        Content-MD5: ""
        Content-Type: application/xml
      Parameters:
        BucketName: '{{ bucketName }}'
        RegionId: '{{ regionId }}'
      Body: '<?xml version="1.0" encoding="UTF-8"?>{{ convertXmlParameters.xmlValues }}</RefererConfiguration>'
  - Name: waitBucketRefererNoRefererList
    Action: 'ACS::WaitFor'
    Description:
      name-en: Wait for the bucket referer modification to complete when referer is allowed to be empty.
      name-zh-cn: 等待存储空间防盗链允许为空时修改完成。
    When:
      'Fn::Equals':
        - '{{ refererList }}'
        - []
    OnSuccess: 'ACS::END'
    Properties:
      Service: OSS
      API: GetBucketReferer
      Method: GET
      URI: '?referer'
      Headers: {}
      Parameters:
        BucketName: '{{ bucketName }}'
        RegionId: '{{ regionId }}'
      DesiredValues:
        - '{{ allowEmptyReferer }}'
      PropertySelector: '.RefererConfiguration.AllowEmptyReferer'
  - Name: waitBucketReferer
    Action: 'ACS::WaitFor'
    Description:
      name-en: Wait for the bucket referer modification to complete.
      name-zh-cn: 等待存储空间防盗链修改完成。
    Properties:
      Service: OSS
      API: GetBucketReferer
      Method: GET
      URI: '?referer'
      Headers: {}
      Parameters:
        BucketName: '{{ bucketName }}'
        RegionId: '{{ regionId }}'
      NotDesiredValues: '{{ refererList }}'
      PropertySelector: '.RefererConfiguration.RefererList.Referer-{{ refererList }}'
Outputs:
  refererInfo:
    Type: Json
    Value:
      bucketName: '{{ bucketName }}'
      allowEmptyReferer: '{{ allowEmptyReferer }}'
      refererList: '{{ refererList }}'

