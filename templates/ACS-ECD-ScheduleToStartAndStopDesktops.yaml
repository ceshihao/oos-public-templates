FormatVersion: OOS-2019-06-01
Description:
  en: Schedule to start and stop desktops
  zh-cn: 定时开启和停止云桌面
  name-en: ACS-ECD-ScheduleToStartAndStopDesktops
  name-zh-cn: 定时开启和停止云桌面
  categories:
    - time_trigger
Parameters:
  regionId:
    Description:
      en: The id of region
      zh-cn: 地域ID
    Type: String
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  desktopIds:
    Description:
      en: The id of desktop
      zh-cn: 云桌面ID
    Type: List
    Default: []
  dailyStartTime:
    Description:
      en: Daily start instance time
      zh-cn: 每天开启实例的时间
    Type: String
    AssociationProperty: DateTime
    AssociationPropertyMetadata:
      Format: 'HH:mm:ssZ'
  dailyStopTime:
    Description:
      en: Daily stop instance time
      zh-cn: 每天停止实例的时间
    Type: String
    AssociationProperty: DateTime
    AssociationPropertyMetadata:
      Format: 'HH:mm:ssZ'
  weekdays:
    Description:
      en: >-
        The Cycle of task，* indicates daily, MON indicates Monday only, MON-FRI
        indicates Monday to Friday，refer them here:
        https://help.aliyun.com/document_detail/169784.html
      zh-cn: >-
        任务执行的周期，*表示每天，MON表示仅周一，MON-FRI表示周一到周五。详情参考：https://help.aliyun.com/document_detail/169784.html
    Type: String
    Default: MON-FRI
  triggerEndDate:
    Description:
      en: 'The end date of time trigger. Format: yyyy-MM-ddTHH:mm:ssZ.'
      zh-cn: '时间触发器结束时间。格式：yyyy-MM-ddTHH:mm:ssZ'
    Type: String
    AssociationProperty: DateTime
    AssociationPropertyMetadata:
      Format: 'YYYY-MM-DDTHH:mm:ssZ'
    Default: '2099-12-01T00:00:00Z'
  rateControl:
    Description:
      en: Concurrency ratio of task execution.
      zh-cn: 任务执行的并发比率。
    Type: Json
    AssociationProperty: RateControl
    Default:
      Mode: Concurrency
      MaxErrors: 100%
      Concurrency: 10
  OOSAssumeRole:
    Description:
      en: The RAM role to be assumed by OOS.
      zh-cn: OOS扮演的RAM角色。
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: timerTrigger
    Action: 'ACS::TimerTrigger'
    Description:
      en: Triggers a task as scheduled by specifying Cron expression.
      zh-cn: 通过指定Cron表达式按计划触发任务。
    Properties:
      Type: cron
      EndDate: '{{ triggerEndDate }}'
      Expression:
        'Fn::Join':
          - ' '
          - - '0'
            - 'Fn::Select':
                - 1
                - 'Fn::Split':
                    - ':'
                    - '{{ dailyStartTime }}'
            - 'Fn::Select':
                - 0
                - 'Fn::Split':
                    - ':'
                    - '{{ dailyStartTime }}'
            - '?'
            - '*'
            - '{{ weekdays }}'
  - Name: getDesktop
    Description:
      en: Query the ECD desktops
      zh-cn: 获取云桌面
    Action: 'ACS::ExecuteApi'
    Properties:
      Service: ECD
      API: DescribeDesktops
      Parameters:
        RegionId: '{{ regionId }}'
        DesktopId: '{{ desktopIds }}'
    Outputs:
      desktopIds:
        Type: List
        ValueSelector: 'Desktops[].DesktopId'
  - Name: startDesktops
    Action: 'ACS::ECD::StartDesktop'
    Description:
      en: Start the desktops
      zh-cn: 开启云桌面
    Properties:
      regionId: '{{ regionId }}'
      desktopId: '{{ ACS::TaskLoopItem }}'
    Loop:
      RateControl: '{{ rateControl }}'
      Items: '{{ getDesktop.desktopIds }}'
  - Name: sleepToSpecifiedTime
    Description:
      en: Sleep to desktop stop time
      zh-cn: 睡眠到实例停止时间
    Action: 'ACS::Sleep'
    Properties:
      EndDate:
        'Fn::FormatUTCTime':
          - 'Fn::CalculateTimeByOpsWindow':
              - '{{ dailyStopTime }}'
              - '{{ dailyStopTime }}'
          - '%Y-%m-%dT%H:%M:%SZ'
  - Name: stopDesktop
    Action: 'ACS::ECD::StopDesktop'
    Description:
      en: Stop the desktops
      zh-cn: 停止云桌面
    Properties:
      regionId: '{{ regionId }}'
      desktopId: '{{ ACS::TaskLoopItem }}'
    Loop:
      RateControl: '{{ rateControl }}'
      Items: '{{ getDesktop.desktopIds }}'

