FormatVersion: OOS-2019-06-01
Description:
  en: "Bulky clone ECS instance.Notice:
    1. Please check whether the driver is missing before you migrate, so as not to cause the new instance to fail to start
    2. Based on mirrored snapshot migration, if you need to retain complete data, please stop the machine before performing the next operation. If you don't need to retain the data generated during the migration process, you don't need to stop the machine, just migrate directly according to the instructions."
  zh-cn: 批量克隆ECS实例。注意：
    1、您在迁移之前请检查是否缺少驱动，以免造成新的实例无法启动
    2、基于镜像快照迁移，如果需要要保留完整数据，请先停机再执行下一步操作，如果不需要保留迁移过程中产生的数据，无需停机，直接根据指引迁移即可。
  name-en: ACS-ECS-BulkyCloneInstances
  name-zh-cn: 批量克隆ECS实例
  categories:
    - cross_region
Parameters:
  regionId:
    Type: String
    Label:
      en: RegionId
      zh-cn: 将要克隆的ECS实例所在地域
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  instanceIds:
    Label:
      en: InstanceIds
      zh-cn: 将要克隆的ECS实例
    Type: List
    AssociationProperty: ALIYUN::ECS::Instance::InstanceId
    AssociationPropertyMetadata:
      RegionId: regionId
  targetZoneId:
    Label:
      en: TargetZoneId
      zh-cn: 可用区
    Description:
      en: For more instance purchase information, please refer to the ECS purchase page
      zh-cn: 更多实例购买信息请查看ECS购买页：https://ecs-buy.aliyun.com/
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      RegionId: regionId
  targetInstanceChargeType:
    Label:
      en: TargetInstanceChargeType
      zh-cn: 付费方式
    Type: String
    AssociationProperty: ChargeType
  targetPeriodUnit:
    Label:
      en: The unit of the subscription period
      zh-cn: 包年包月计费方式的时长单位
    Type: String
    AssociationPropertyMetadata:
      Visible:
        Condition:
          'Fn::Not':
            'Fn::Equals':
              - '${targetInstanceChargeType}'
              - PostPaid
    AllowedValues:
      - Week
      - Month
    Default: Month
  targetPeriod:
    Label:
      en: TargetPeriod
      zh-cn: 购买包年包月资源的时长
    Description:
      en: "Valid values:
          Valid values when PeriodUnit is set to Week: 1, 2, 3, and 4.
          Valid values when PeriodUnit is set to Month: 1, 2, 3, 4, 5, 6, 7, 8, 9, 12, 24, 36, 48, and 60."
      zh-cn: 取值范围：
             PeriodUnit=Week时，Period取值：{“1”, “2”, “3”, “4”}。
             PeriodUnit=Month时，Period取值：{“1”, “2”, “3”, “4”, “5”, “6”, “7”, “8”, “9”, “12”, “24”, “36”, ”48”, ”60”}。
    Type: Number
    AssociationPropertyMetadata:
      Visible:
        Condition:
          'Fn::Not':
            'Fn::Equals':
              - '${targetInstanceChargeType}'
              - PostPaid
    AllowedValues:
      - 1
      - 2
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
      - 12
      - 24
      - 36
      - 48
      - 60
    Default: 1
  targetInstanceType:
    Label:
      en: TargetInstanceType
      zh-cn: 资源规格
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      InstanceChargeType: targetInstanceChargeType
  targetVPCId:
    Label:
      en: TargetVPCId
      zh-cn: 专有网络
    Type: String
    AssociationProperty: ALIYUN::ECS::VPC::VPCId
    AssociationPropertyMetadata:
      RegionId: regionId
  targetVSwitchId:
    Label:
      en: TargetVSwitchId
      zh-cn: 虚拟交换机
    Description:
      en: Please confirm whether the switch is in the selected zone. If not, please reselect or create a new switch
      zh-cn: 请确认交换机是否在所选可用区内，若不在请重新选择或新建交换机
    Type: String
    AssociationProperty: ALIYUN::VPC::VSwitch::VSwitchId
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      VpcId: targetVPCId
  targetSecurityGroupIds:
    Label:
      en: TargetSecurityGroupIds
      zh-cn: 安全组
    Description:
      en: The vSwitch and the security group must belong to the same VPC
      zh-cn: 安全组和虚拟交换机必须在同一个专有网络VPC中
    Type: List
    AssociationProperty: ALIYUN::ECS::SecurityGroup::SecurityGroupId
    AssociationPropertyMetadata:
      RegionId: regionId
      VpcId: targetVPCId
  targetSystemDiskCategory:
    Label:
      en: TargetSystemDiskCategory
      zh-cn: 系统盘的种类
    Type: String
    AssociationProperty: ALIYUN::ECS::Disk::SystemDiskCategory
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      InstanceType: targetInstanceType
      InstanceChargeType: targetInstanceChargeType
  targetDataDiskCategory:
    Label:
      en: TargetDataDiskCategory
      zh-cn: 数据盘的种类
    Type: String
    AssociationProperty: ALIYUN::ECS::Disk::DataDiskCategory
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      InstanceType: targetInstanceType
      InstanceChargeType: targetInstanceChargeType
  targetPassword:
    Label:
      en: TargetPassword
      zh-cn: 实例密码
    Description:
      en: "<font color='red'><b>The password must be 8 to 30 characters in length and include at least three of the following character types: uppercase letters, lowercase letters, digits, and special characters.</b></font>Special characters include: ()`~!@#$%^&*-_+=|{}[]:;''<>,.?/  Passwords of Windows instances cannot start with a forward slash (/)."
      zh-cn: <font color='red'><b>长度为8至30个字符，必须同时包含大小写英文字母、数字和特殊符号中的三类字符。</b></font>特殊符号可以是： ()`~!@#$%^&*-_+=|{}[]:;'<>,.?/ ，其中，Windows实例不能以正斜线（/）为密码首字符
    Type: String
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    MinLength: 8
    MaxLength: 30
    NoEcho: true
  OOSAssumeRole:
    Label:
      en: OOSAssumeRole
      zh-cn: OOS扮演的RAM角色
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: cloneInstances
    Action: ACS::Template
    Description:
      en: Clone ECS instances
      zh-cn: 克隆ECS实例
    Properties:
      TemplateName: ACS::ECS::CloneInstance
      Parameters:
        regionId: '{{ regionId }}'
        imageName: img-{{ ACS::TaskLoopItem }}-{{ACS::ExecutionId}}
        instanceId: '{{ ACS::TaskLoopItem }}'
        targetVSwitchId: '{{ targetVSwitchId }}'
        targetInstanceType: '{{ targetInstanceType }}'
        targetSecurityGroupIds: '{{ targetSecurityGroupIds }}'
        targetPassword: '{{ targetPassword }}'
        targetInstanceChargeType: '{{ targetInstanceChargeType }}'
        targetPeriodUnit: '{{ targetPeriodUnit }}'
        targetPeriod: '{{ targetPeriod }}'
        targetSystemDiskCategory: '{{ targetSystemDiskCategory }}'
        targetDataDiskCategory: '{{ targetDataDiskCategory }}'
    Loop:
      Items: '{{ instanceIds }}'
      RateControl:
        Mode: Concurrency
        MaxErrors: 0
        Concurrency: 10
Metadata:
  ALIYUN::OOS::Interface:
    ParameterGroups:
      - Parameters:
          - regionId
          - instanceIds
        Label:
          default:
            zh-cn: 选择实例
            en: Select Instances
      - Parameters:
          - targetZoneId
          - targetInstanceChargeType
          - targetPeriodUnit
          - targetPeriod
          - targetInstanceType
          - targetVPCId
          - targetVSwitchId
          - targetSecurityGroupIds
          - targetSystemDiskCategory
          - targetDataDiskCategory
          - targetPassword
        Label:
          default:
            zh-cn: 配置参数
            en: Configure Parameters
      - Parameters:
          - OOSAssumeRole
        Label:
          default:
            zh-cn: 高级选项
            en: Control Options
