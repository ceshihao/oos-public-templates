FormatVersion: OOS-2019-06-01
Description:
  en: Bulky clone ECS instance
  zh-cn: 批量克隆ECS实例
  name-en: ACS-ECS-BulkyCloneInstances
  name-zh-cn: 批量克隆ECS实例
  categories:
    - cross_region
Parameters:
  regionId:
    Type: String
    Description:
      name-en: The region of instance to clone
      name-zh-cn: 将要克隆的ECS实例所在地域
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  instanceIds:
    Description:
      name-en: Target instance to clone
      name-zh-cn: 将要克隆的ECS实例
    Type: List
    AssociationProperty: ALIYUN::ECS::Instance::InstanceId
    AssociationPropertyMetadata:
      RegionId: regionId
  targetZoneId:
    Description:
      name-en: The target zone id of new instance
      name-zh-cn: 可用区
      en: For more instance purchase information, please refer to the ECS purchase page
      zh-cn: 更多实例购买信息请查看ECS购买页：https://ecs-buy.aliyun.com/
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      RegionId: regionId
  targetInstanceChargeType:
    Description:
      name-en: targetInstanceChargeType
      name-zh-cn: 付费方式
    Type: String
    AssociationProperty: ChargeType
  targetPeriodUnit:
    Description:
      name-en: The unit of the subscription period
      name-zh-cn: 包年包月计费方式的时长单位
    Type: String
    AssociationPropertyMetadata:
      Visible:
        Condition:
          'Fn::Not':
            'Fn::Equals':
              - '${targetInstanceChargeType}'
              - PostPaid
    AllowedValues:
      - Week
      - Month
    Default: Month
  targetPeriod:
    Description:
      name-en: The subscription period of the instance
      name-zh-cn: 购买包年包月资源的时长
      en: "Valid values:
          Valid values when PeriodUnit is set to Week: 1, 2, 3, and 4.
          Valid values when PeriodUnit is set to Month: 1, 2, 3, 4, 5, 6, 7, 8, 9, 12, 24, 36, 48, and 60."
      zh-cn: 取值范围：
             PeriodUnit=Week时，Period取值：{“1”, “2”, “3”, “4”}。
             PeriodUnit=Month时，Period取值：{“1”, “2”, “3”, “4”, “5”, “6”, “7”, “8”, “9”, “12”, “24”, “36”, ”48”, ”60”}。
    Type: Number
    AssociationPropertyMetadata:
      Visible:
        Condition:
          'Fn::Not':
            'Fn::Equals':
              - '${targetInstanceChargeType}'
              - PostPaid
    AllowedValues:
      - 1
      - 2
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
      - 9
      - 12
      - 24
      - 36
      - 48
      - 60
    Default: 1
  targetInstanceType:
    Description:
      name-en: The instance type for the new ECS instances
      name-zh-cn: 资源规格
    Type: String
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      InstanceChargeType: targetInstanceChargeType
  targetVPCId:
    Description:
      name-en: VPC ID of new ECS instances
      name-zh-cn: 专有网络
    Type: String
    AssociationProperty: ALIYUN::ECS::VPC::VPCId
    AssociationPropertyMetadata:
      RegionId: regionId
  targetVSwitchId:
    Description:
      name-en: The virtual switch id for the new ECS instances
      name-zh-cn: 虚拟交换机
      en: Please confirm whether the switch is in the selected zone. If not, please reselect or create a new switch
      zh-cn: 请确认交换机是否在所选可用区内，若不在请重新选择或新建交换机
    Type: String
    AssociationProperty: ALIYUN::VPC::VSwitch::VSwitchId
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      VpcId: targetVPCId
  targetSecurityGroupIds:
    Description:
      name-en: The security group id for the new ECS instances
      name-zh-cn: 安全组
      en: The vSwitch and the security group must belong to the same VPC
      zh-cn: 安全组和虚拟交换机必须在同一个专有网络VPC中
    Type: List
    AssociationProperty: ALIYUN::ECS::SecurityGroup::SecurityGroupId
    AssociationPropertyMetadata:
      RegionId: regionId
      VpcId: targetVPCId
  targetSystemDiskCategory:
    Description:
      name-en: The category of system disk
      name-zh-cn: 系统盘的种类
    Type: String
    AssociationProperty: ALIYUN::ECS::Disk::SystemDiskCategory
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      InstanceType: targetInstanceType
      InstanceChargeType: targetInstanceChargeType
  targetDataDiskCategory:
    Description:
      name-en: The category of data disk
      name-zh-cn: 数据盘的种类
    Type: String
    AssociationProperty: ALIYUN::ECS::Disk::DataDiskCategory
    AssociationPropertyMetadata:
      RegionId: regionId
      ZoneId: targetZoneId
      InstanceType: targetInstanceType
      InstanceChargeType: targetInstanceChargeType
  targetPassword:
    Description:
      name-en: The password of the new ECS instance
      name-zh-cn: 实例密码
      en: 'The password must be 8 to 30 characters in length and include at least three of the following character types: uppercase letters, lowercase letters, digits, and special characters. Special characters include: ()`~!@#$%^&*-_+=|{}[]:;''<>,.?/  Passwords of Windows instances cannot start with a forward slash (/).'
      zh-cn: 长度为8至30个字符，必须同时包含大小写英文字母、数字和特殊符号中的三类字符。特殊符号可以是： ()`~!@#$%^&*-_+=|{}[]:;'<>,.?/ ，其中，Windows实例不能以正斜线（/）为密码首字符。
    Type: String
    NoEcho: true
  OOSAssumeRole:
    Description:
      name-en: The RAM role to be assumed by OOS
      name-zh-cn: OOS扮演的RAM角色
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: cloneInstances
    Action: ACS::Template
    Description:
      en: Clone ECS instances
      zh-cn: 克隆ECS实例
    Properties:
      TemplateName: ACS::ECS::CloneInstance
      Parameters:
        regionId: '{{ regionId }}'
        imageName: img-{{ ACS::TaskLoopItem }}-{{ACS::ExecutionId}}
        instanceId: '{{ ACS::TaskLoopItem }}'
        targetVSwitchId: '{{ targetVSwitchId }}'
        targetInstanceType: '{{ targetInstanceType }}'
        targetSecurityGroupIds: '{{ targetSecurityGroupIds }}'
        targetPassword: '{{ targetPassword }}'
        targetInstanceChargeType: '{{ targetInstanceChargeType }}'
        targetPeriodUnit: '{{ targetPeriodUnit }}'
        targetPeriod: '{{ targetPeriod }}'
        targetSystemDiskCategory: '{{ targetSystemDiskCategory }}'
        targetDataDiskCategory: '{{ targetDataDiskCategory }}'
    Loop:
      Items: '{{ instanceIds }}'
      RateControl:
        Mode: Concurrency
        MaxErrors: 0
        Concurrency: 10

