FormatVersion: OOS-2019-06-01
Description:
  en: Bulky downLoad file to instances and run command.
  zh-cn: 批量下载文件到多个ECS实例并执行云助手命令。
  name-en: ACS-ECS-BulkyDownloadFileAndRunCommand
  name-zh-cn: 批量下载文件到多个ECS实例并执行云助手命令
  categories:
    - instance_manage
Parameters:
  regionId:
    Type: String
    Description:
      en: The id of region.
      zh-cn: 地域ID。
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  targets:
    Type: Json
    AssociationProperty: Targets
    AssociationPropertyMetadata:
      ResourceType: 'ALIYUN::ECS::Instance'
      RegionId: regionId
  sourceType:
    Type: String
    Description:
      en: The type of file storage.
      zh-cn: 文件存储的类型。
    AllowedValues:
      - oss
      - https
  sourcePath:
    Type: String
    Description:
      en: You must specify a URL where the file is stored.
      zh-cn: 您必须指定用于存储文件的URL。
  destinationDir:
    Description:
      en: Target directory for file copy in instance.
      zh-cn: 实例中文件复制的目标目录。
    Type: String
  commandContent:
    Description:
      en: Command content to run in ECS instance.
      zh-cn: 在ECS实例中执行的云助手命令。
    Type: String
    AssociationProperty: Code
    Default: echo hello
  workingDir:
    Description:
      en: 'The directory where the created command runs on the ECS instances.Linux instances: under the home directory of the administrator (root user): /root.Windows instances: under the directory where the process of the Cloud Assistant client is located, such asC:\Windows\System32.'
      zh-cn: '脚本在ECS实例中的运行目录。Linux系统实例默认在管理员（root用户）的home目录下，即/root。Windows系统实例默认在云助手客户端进程所在目录，例如C:\Windows\System32。'
    Type: String
    Default: ''
  timeout:
    Description:
      en: The value of the invocation timeout period of a command on ECS instances.
      zh-cn: ECS实例中执行命令的超时时间。
    Type: Number
    Default: 600
  rateControl:
    Description:
      en: Concurrency ratio of task execution.
      zh-cn: 任务执行的并发比率。
    Type: Json
    AssociationProperty: RateControl
    Default:
      Mode: Concurrency
      MaxErrors: 0
      Concurrency: 10
  OOSAssumeRole:
    Description: The RAM role to be assumed by OOS.
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: getInstance
    Description:
      en: Views the ECS instances.
      zh-cn: 获取ECS实例。
    Action: 'ACS::SelectTargets'
    Properties:
      ResourceType: 'ALIYUN::ECS::Instance'
      RegionId: '{{ regionId }}'
      Filters:
        - '{{ targets }}'
    Outputs:
      instanceIds:
        Type: List
        ValueSelector: 'Instances.Instance[].InstanceId'
  - Name: downloadFileAndRunCommand
    Action: ACS::ECS::DownloadFileAndRunCommand
    Description:
      en: Downloads file to the ECS instances adn run command.
      zh-cn: 下载文件到实例并执行命令。
    Properties:
      regionId: '{{ regionId }}'
      instanceId: '{{ ACS::TaskLoopItem }}'
      sourceType: '{{ sourceType }}'
      sourcePath: '{{ sourcePath }}'
      destinationDir: '{{ destinationDir }}'
      commandContent: '{{ commandContent }}'
      workingDir: '{{ workingDir }}'
      timeout: '{{ timeout }}'
    Loop:
      Items: '{{ getInstance.instanceIds }}'
      RateControl: '{{ rateControl }}'

