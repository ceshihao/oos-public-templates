FormatVersion: OOS-2019-06-01
Description:
  en: Bulky run command on ECS instances
  zh-cn: 批量在多台ECS实例上运行云助手命令
  name-en: ACS-ECS-BulkyRunCommand
  name-zh-cn: 批量在ECS实例上运行命令
  categories:
    - run_command
    - application_manage
Parameters:
  regionId:
    Type: String
    Description:
      name-en: The id of region
      name-zh-cn: 地域ID
    Label:
      en: Region
      zh-cn: 地域
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  targets:
    Type: Json
    Label:
      en: TargetInstance
      zh-cn: 目标实例
    AssociationProperty: Targets
    AssociationPropertyMetadata:
      ResourceType: ALIYUN::ECS::Instance
      RegionId: regionId
  commandType:
    Description:
      name-en: The type of command
      name-zh-cn: 云助手命令类型
    Label:
      en: CommandType
      zh-cn: 云助手命令类型
    Type: String
    AllowedValues:
      - RunBatScript
      - RunPowerShellScript
      - RunShellScript
    Default: RunShellScript
  commandContent:
    Description:
      name-en: Command content to run in ECS instance
      name-zh-cn: 在ECS实例中执行的云助手命令
    Label:
      en: CommandContent
      zh-cn: 云助手命令
    Type: String
    MaxLength: 16384
    AssociationProperty: Code
    Default: echo hello
  workingDir:
    Description:
      name-en: The directory where the created command runs on the ECS instances
      name-zh-cn: 脚本在ECS实例中的运行目录
      en: 'Linux instances: under the home directory of the administrator (root user): /root.Windows instances: under the directory where the process of the Cloud Assistant client is located, such asC:\Windows\System32'
      zh-cn: 'Linux系统实例默认在管理员（root用户）的home目录下，即/root。Windows系统实例默认在云助手客户端进程所在目录，例如C:\Windows\System32'
    Label:
      en: WorkingDir
      zh-cn: 运行目录
    Type: String
    Default: ''
  timeout:
    Description:
      name-en: The value of the invocation timeout period of a command on ECS instances
      name-zh-cn: ECS实例中执行命令的超时时间
    Label:
      en: Timeout
      zh-cn: 超时时间
    Type: Number
    Default: 600
  enableParameter:
    Description:
      name-en: Whether to include secret parameters or custom parameters in the command
      name-zh-cn: 命令中是否包含加密参数或自定义参数
    Label:
      en: EnableParameter
      zh-cn: 命令中是否包含加密参数或自定义参数
    Type: Boolean
    Default: false
  username:
    Description:
      name-en: The username that is used to run the command on the ECS instance
      name-zh-cn: 在ECS实例中执行命令的用户名称
    Label:
      en: Username
      zh-cn: 执行命令的用户名称
    Type: String
    Default: ''
  windowsPasswordName:
    Description:
      name-en: The name of the password used to run the command on a Windows instance
      name-zh-cn: 在Windows实例中执行命令的用户的密码名称
    Label:
      en: WindowsPasswordName
      zh-cn: 在Windows实例中执行命令的用户的密码名称
    Type: String
    Default: ''
    AssociationProperty: SecretParameterName
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Or:
            - Fn::Equals:
                - ${commandType}
                - RunBatScript
            - Fn::Equals:
                - ${commandType}
                - RunPowerShellScript
  rateControl:
    Description:
      name-en: Concurrency ratio of task execution
      name-zh-cn: 任务执行的并发比率
    Label:
      en: RateControl
      zh-cn: 任务执行的并发比率
    Type: Json
    AssociationProperty: RateControl
    Default:
      Mode: Concurrency
      MaxErrors: 0
      Concurrency: 10
  OOSAssumeRole:
    Description:
      name-en: The RAM role to be assumed by OOS
      name-zh-cn: OOS扮演的RAM角色
    Label:
      en: OOSAssumeRole
      zh-cn: OOS扮演的RAM角色
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: getInstance
    Description:
      name-en: Views the ECS instances
      name-zh-cn: 获取ECS实例
    Action: ACS::SelectTargets
    Properties:
      ResourceType: ALIYUN::ECS::Instance
      RegionId: '{{ regionId }}'
      Filters:
        - '{{ targets }}'
    Outputs:
      instanceIds:
        Type: List
        ValueSelector: Instances.Instance[].InstanceId
  - Name: runCommand
    Action: ACS::ECS::RunCommand
    Description:
      name-en: Execute cloud assistant command
      name-zh-cn: 执行云助手命令
    Properties:
      regionId: '{{ regionId }}'
      commandContent: '{{ commandContent }}'
      instanceId: '{{ ACS::TaskLoopItem }}'
      commandType: '{{ commandType }}'
      workingDir: '{{ workingDir }}'
      timeout: '{{ timeout }}'
      enableParameter: '{{ enableParameter }}'
      username: '{{ username }}'
      windowsPasswordName: '{{ windowsPasswordName }}'
    Loop:
      RateControl: '{{ rateControl }}'
      Items: '{{ getInstance.instanceIds }}'
      Outputs:
        commandOutputs:
          AggregateType: Fn::ListJoin
          AggregateField: commandOutput
    Outputs:
      commandOutput:
        Type: String
        ValueSelector: invocationOutput
Outputs:
  commandOutputs:
    Type: List
    Value: '{{ runCommand.commandOutputs }}'
Metadata:
  ALIYUN::OOS::Interface:
    ParameterGroups:
      - Parameters:
          - commandType
          - commandContent
          - workingDir
          - timeout
          - enableParameter
          - username
          - windowsPasswordName
        Label:
          default:
            zh-cn: 执行命令选型
            en: run command options
      - Parameters:
          - regionId
          - targets
        Label:
          default:
            zh-cn: 选择实例
            en: Select Ecs Instances
      - Parameters:
          - rateControl
          - OOSAssumeRole
        Label:
          default:
            zh-cn: 高级选项
            en: Control Options
    Hidden:
      - username
      - enableParameter


