FormatVersion: OOS-2019-06-01
Description:
  en: Bulky modify prepay instance spec
  zh-cn: 批量修改包年包月ECS实例的实例规格。
  name-en: ACS-ECS-BulkyModifyPrepayInstanceSpec
  name-zh-cn: 批量修改包年包月ECS实例的实例规格
  categories:
    - instance_manage
Parameters:
  regionId:
    Description:
      name-en: The id of region.
      name-zh-cn: 地域ID。
    Type: String
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  targets:
    Type: Json
    AssociationProperty: Targets
    AssociationPropertyMetadata:
      ResourceType: 'ALIYUN::ECS::Instance'
      RegionId: regionId
  operatorType:
    Description:
      name-en: The operation type.
      name-zh-cn: 实例升降级类型。
    Type: String
    AllowedValues:
      - downgrade
      - upgrade
    Default: upgrade
  instanceType:
    Description:
      name-en: The instance type for the ECS instances.
      name-zh-cn: 实例类型。
    Type: String
    AssociationProperty: 'ALIYUN::ECS::Instance::InstanceType'
  rateControl:
    Description:
      name-en: Concurrency ratio of task execution.
      name-zh-cn: 任务执行的并发比率。
    Type: Json
    AssociationProperty: RateControl
    Default:
      Mode: Concurrency
      MaxErrors: 0
      Concurrency: 10
  OOSAssumeRole:
    Description:
      name-en: The RAM role to be assumed by OOS.
      name-zh-cn: OOS扮演的RAM角色。
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
- Name: getInstance
  Description:
    name-en: Views the ECS instances.
    name-zh-cn: 获取ECS实例。
  Action: 'ACS::SelectTargets'
  Properties:
    ResourceType: 'ALIYUN::ECS::Instance'
    RegionId: '{{ regionId }}'
    Filters:
      - '{{ targets }}'
  Outputs:
    instanceIds:
      Type: List
      ValueSelector: 'Instances.Instance[].InstanceId'
- Name: modifyPrepayInstanceSpec
  Action: ACS::ECS::ModifyPrepaySpec
  Description:
    name-en: Modify the type of prepaid instance.
    name-zh-cn: 修改预付费实例的实例规格。
  Properties:
    regionId: '{{ regionId }}'
    instanceId: '{{ ACS::TaskLoopItem }}'
    instanceType: '{{ instanceType }}'
    operatorType: '{{ operatorType }}'
  Loop:
    RateControl: '{{ rateControl }}'
    Items: '{{ getInstance.instanceIds }}'

