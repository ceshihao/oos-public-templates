FormatVersion: OOS-2019-06-01
Description:
  name-en: ACS-ECS-CodeDeployConsole
  name-zh-cn: CodeDeploy控制台渲染
Parameters:
  description:
    Type: String
    Label:
      en: Description
      zh-cn: 描述
    Description:
      en: Description of the current deployment version
      zh-cn: 当前部署物版本的描述
    Default: ''
  revisionType:
    Type: String
    Label:
      en: RevisionType
      zh-cn: 部署物类型
    Default: Oss
    AssociationProperty: ALIYUN::OOS::Component::SectionType
    AssociationPropertyMetadata:
      Sections:
        - name: Oss
          title:
            zh-cn: OSS文件
            en: OSS File
          description:
            zh-cn: 适用于应用源文件是OSS文件的场景。<br><a href="https://help.aliyun.com/zh/ecs/user-guide/oss-objects?spm=a2c4g.11186623.help-menu-25365.d_0_6_1_5_0_0.6a6a5a7dCmrBio&scm=20140722.H_3000807._.OR_help-T_cn~zh-V_1" target="_blank">帮助文档</a>
            en: Applicable to the scenario where the application source file is an OSS file.
        - name: GitRepo
          title:
            zh-cn: Git仓库代码
            en: Git Repo Code
          description:
            zh-cn: 适用于应用源文件是存储在Git仓库中代码的场景。<br><a href="https://help.aliyun.com/zh/ecs/user-guide/git-object?spm=a2c4g.11186623.help-menu-25365.d_0_6_1_5_0_1.41505ff5I8wiO7" target="_blank">帮助文档</a>
            en: Applicable to the scenario where the application source file is the code stored in the Git repository.
        - name: EcsImage
          title:
            zh-cn: ECS镜像
            en: ECS Image
          description:
            zh-cn: 适用于应用源文件是ECS镜像的场景。<br><a href="https://help.aliyun.com/zh/ecs/user-guide/ecs-image-deployment-object?spm=a2c4g.11186623.help-menu-25365.d_0_6_1_5_0_2.280f5ff5PvdNpX" target="_blank">帮助文档</a>
            en: Applicable to the scenario where the application source file is an ECS image.
        - name: DockerImage
          title:
            zh-cn: Docker镜像
            en: Docker Image
          description:
            zh-cn: 适用于应用源文件是阿里云ACR仓库中Docker镜像的场景。<br><a href="https://help.aliyun.com/zh/ecs/user-guide/docker-image-object?spm=a2c4g.11186623.help-menu-25365.d_0_6_1_5_0_3.396320044psefv" target="_blank">帮助文档</a>
            en: Applicable to the scenario where the application source file is a Docker image in ACR repository.
        - name: Command
          title:
            zh-cn: 仅执行命令
            en: Execute Command
          description:
            zh-cn: 适用于没有源文件，仅执行命令完成应用发布的场景。<br><a href="https://help.aliyun.com/zh/ecs/user-guide/execute-command-only-deployments?spm=a2c4g.11186623.help-menu-25365.d_0_6_1_5_0_4.57753af37pA6uC" target="_blank">帮助文档</a>
            en: Applicable to the scenario where there is no source file and only the command is executed to complete the application release.
  regionIdOSS:
    Label:
      en: OSS RegionId
      zh-cn: OSS地域
    Type: String
    Default: '{{ ACS::RegionId }}'
    AssociationProperty: RegionId
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
          - ${revisionType}
          - Oss
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
  bucketName:
    Label:
      en: OSS Bucket
      zh-cn: OSS Bucket
    Type: String
    Default: ''
    AssociationProperty: ALIYUN::OSS::Bucket::BucketName
    AssociationPropertyMetadata:
      RegionId: regionIdOSS
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
  objectName:
    Label:
      en: ObjectName
      zh-cn: OSS文件
    Type: String
    Default: ''
    Description:
      en: Please fill in the complete path of the file in the Bucket, for example： mydir/file/test.zip. (Do not start with /)
      zh-cn: 请填写文件在Bucket中的完整路径，示例：mydir/file/test.zip。（请勿以/开头）
    AssociationProperty: ALIYUN::OSS::Object::ObjectName
    AssociationPropertyMetadata:
      RegionId: regionIdOSS
      BucketName: bucketName
      ValueType: bucketName
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
  versionId:
    Label:
      en: VersionId
      zh-cn: OSS文件版本
    Description:
      en: Only if version control is enabled for OSS, please ignore it. Reference Documents -- <a href="https://www.alibabacloud.com/help/en/oss/overview-78/?spm=a2c63.p38356.help-menu-31815.d_10_3.1bd27d7dEhHH8Y&scm=20140722.H_109695._.OR_help-T_intl~en-V_1" target="_blank">OSS Version Control</a>
      zh-cn: 只有OSS已开启版本控制才能选择，否则请忽略。参考文档：<a href="https://help.aliyun.com/zh/oss/overview-78/?spm=a2c4g.11174283.help-menu-search-31815.d_2" target="_blank">OSS版本控制</a>
    Default: ''
    Type: String
    AssociationProperty: ALIYUN::OSS::Object::ObjectVersionId
    AssociationPropertyMetadata:
      RegionId: regionIdOSS
      BucketName: bucketName
      ObjectName: objectName
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
  isInternalOSS:
    Label:
      en: Intranet download
      zh-cn: 内网下载
    Description:
      en: Whether to download the OSS file through the intranet. Note that If you choose to download the intranet, you must ensure that the ECS and OSS you want to deploy must be in the same region.
      zh-cn: 是否通过内网下载OSS文件。注意：如果选择内网下载，必须保证要部署的ECS和OSS同地域。
    Type: Boolean
    Default: false
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
  platform:
    Type: String
    Label:
      en: Platform
      zh-cn: 平台
    AssociationProperty: ALIYUN::OOS::GitPlatform::Name
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
    Default: gitee
    Description:
      en: Attention! ECS in mainland China may experience unstable GitHub connection.
      zh-cn: 注意：中国内地ECS可能会出现GitHub连接不稳定。
    AllowedValues:
      - gitee
      - github
      - gitlab
  owner:
    Type: String
    Label:
      en: Owner
      zh-cn: 所有者
    Default: ''
    AssociationProperty: ALIYUN::OOS::GitAccount::Name
    AssociationPropertyMetadata:
      Platform: ${platform}
      ShowUnbindCom: true
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
  organization:
    Type: String
    Label:
      en: Organization
      zh-cn: 组织
    Default: ''
    AssociationProperty: ALIYUN::OOS::GitOrganization::Name
    AssociationPropertyMetadata:
      Platform: ${platform}
      Owner: ${owner}
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
  repository:
    Type: String
    Label:
      en: Repository
      zh-cn: 仓库
    Default: ''
    AssociationProperty: ALIYUN::OOS::GitRepository::Name
    AssociationPropertyMetadata:
      Platform: ${platform}
      Organization: ${organization}
      Owner: ${owner}
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
  branch:
    Label:
      en: Branch
      zh-cn: 分支
    Type: String
    Default: ''
    AssociationProperty: ALIYUN::OOS::GitBranch::Name
    AssociationPropertyMetadata:
      Platform: ${platform}
      Organization: ${organization}
      Owner: ${owner}
      RepoFullName: ${repository}
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
  commitId:
    Label:
      en: CommitId
      zh-cn: CommitId
    Description:
      en: After entering a branch, it will automatically get the latest Commit Hash of the branch, you do not need to enter it manually.
      zh-cn: 输入分支后自动获取分支最新的Commit Hash，您无需手动输入。
    Type: String
    Default: ''
    AssociationProperty: ACS::OOS::GitBranch::LatestCommitId
    AssociationPropertyMetadata:
      Platform: ${platform}
      Branch: ${branch}
      Owner: ${owner}
      RepoFullName: ${repository}
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
  imageId:
    Label:
      en: ImageId
      zh-cn: ECS镜像ID
    Description:
      en: You can select different ECS images for different regions. When publishing, the corresponding image will be selected according to the region.
      zh-cn: 您可以为不同地域选择不同的ECS镜像。发布时，会根据ECS所在地域选择对应地域的镜像进行发布。
    Type: String
    Default: ''
    AssociationProperty: Map
    AssociationPropertyMetadata:
      ParameterKey:
        Type: String
        Label:
          en: Region
          zh-cn: 地域
        AssociationProperty: RegionId
      ParameterValue:
        Type: String
        Label:
          en: ImageId
          zh-cn: 镜像ID
        AssociationProperty: ALIYUN::ECS::Image::ImageId
        AssociationPropertyMetadata:
          RegionId: ${.ParameterKey}
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - EcsImage
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - EcsImage
  acrRegion:
    Label:
      en: ACR Region
      zh-cn: 容器镜像服务地域
    Type: String
    Default: '{{ ACS::RegionId }}'
    AssociationProperty: RegionId
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
  acrType:
    Label:
      en: ACR Type
      zh-cn: 容器镜像服务类型
    Type: String
    Default: Personal
    Description:
      en: <strong>Note!</strong> If you are using the personal version type for the first time, please return to the application details page and configure the personal version ACR user name and password in the <strong>advanced settings</strong>!
      zh-cn: <strong>注意!</strong> 如您是首次使用个人版类型，请先返回到应用详情页，在<strong>高级设置</strong>中配置个人版ACR的用户名和密码！
    AllowedValues:
      - Personal
    AssociationPropertyMetadata:
      ValueLabelMapping:
        Personal:
          en: Personal
          zh-cn: 个人版
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
  acrId:
    Label:
      en: ACR Instance ID
      zh-cn: 容器镜像服务实例ID
    Description:
      en: ACR ID, represents the ID of the cloud container registry
      zh-cn: 容器镜像服务实例ID
    Type: String
    Default: ''
    AssociationProperty: ALIYUN::CR::Instance::InstanceId
    AssociationPropertyMetadata:
      RegionId: ${acrRegion}
      Visible:
        Condition:
          Fn::And:
            - Fn::Equals:
                - ${revisionType}
                - DockerImage
            - Fn::Equals:
                - ${acrType}
                - Enterprise
      Required:
        Condition:
          Fn::And:
            - Fn::Equals:
                - ${revisionType}
                - DockerImage
            - Fn::Equals:
                - ${acrType}
                - Enterprise
  namespace:
    Label:
      en: NameSpace
      zh-cn: 命名空间
    Description:
      en: namespace, represents the namespace of the container image
      zh-cn: 容器镜像仓库命名空间
    Type: String
    Default: ''
    AssociationProperty: ALIYUN::CR::NameSpace::Name
    AssociationPropertyMetadata:
      RegionId: ${acrRegion}
      InstanceId: ${acrId}
      Attribute: NamespaceName
      Visible:
        Condition:
          Fn::And:
            - Fn::Equals:
                - ${revisionType}
                - DockerImage
            - Fn::Equals:
                - ${acrType}
                - Enterprise
      Required:
        Condition:
          Fn::And:
            - Fn::Equals:
                - ${revisionType}
                - DockerImage
            - Fn::Equals:
                - ${acrType}
                - Enterprise
  repoName:
    Label:
      en: Repo Name
      zh-cn: 仓库名称
    Description:
      en: Repo Name, represents the repository name of the container image
      zh-cn: 容器镜像仓库名称
    Type: String
    Default: ''
    AssociationProperty: ALIYUN::CR::Repository::RepoName
    AssociationPropertyMetadata:
      AcrType: ${acrType}
      RegionId: ${acrRegion}
      InstanceId: ${acrId}
      RepoNamespaceName: ${namespace}
      RepoStatus: ALL
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
  imageVersion:
    Label:
      en: Image Version
      zh-cn: 镜像版本
    Description:
      en: Please fill in the version of the image to be published.
      zh-cn: 请填写待发布镜像的版本。
    Type: String
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
    Default: ''
  isInternalAcr:
    Label:
      en: whether to use internal link to pull image
      zh-cn: 是否通过内网拉取镜像
    Description:
      en: For enterprise version ACR instance, please complete <a href="https://help.aliyun.com/zh/acr/user-guide/configure-access-over-vpcs/?spm=a2c4g.11186623.0.0.3af016be83KUhr" target="_blank">VPC access control configuration</a> to ensure that the ECS instance and ACR instance are in the same VPC, and the image can be pulled through the internal network.<br>For personal version ACR instance, the ECS instance in the same region can directly pull the image through the internal network, and the ECS instance in different regions needs to use the public network to pull the image.
      zh-cn: 对于企业版ACR实例，需完成<a href="https://help.aliyun.com/zh/acr/user-guide/configure-access-over-vpcs/?spm=a2c4g.11186623.0.0.3af016be83KUhr" target="_blank">VPC访问控制配置</a>，使得待发布的ECS实例和ACR实例处于同一VPC内，才可通过内网拉取镜像。<br>对于个人版ACR实例，同地域的ECS实例无须配置即可直接内网拉取镜像，不同地域的ECS实例请使用公网拉取镜像。
    Type: Boolean
    Default: false
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
      Required:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
  alertDockerImage:
    Type: String
    Label: ''
    Default: ''
    AssociationProperty: Alert
    AssociationPropertyMetadata:
      ShowLabel: false
      Type: warning
      ShowIcon: true
      Title:
        zh-cn: 1）请确保待发布机器上已安装Docker。<br> 2）发布时，Docker镜像会在脚本执行前被自动拉取到ECS实例上，脚本中无需做拉取镜像相关操作。
        en: 1）Please ensure that Docker is installed on the machine to be published. <br> 2）When publishing, the Docker image will be automatically pulled to the ECS instance before the script is executed, and the script does not need to perform the pull image related operation.
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - DockerImage
  alertOss:
    Type: String
    Label: ''
    Default: ''
    AssociationProperty: Alert
    AssociationPropertyMetadata:
      ShowLabel: false
      Type: warning
      ShowIcon: true
      Title:
        zh-cn: 发布时，OSS文件会在脚本执行前被自动下载到工作目录，脚本中无需做下载OSS文件相关操作。
        en: When publishing, the OSS file will be automatically downloaded to the working directory before the script is executed, and the script does not need to perform the download OSS file related operation.
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - Oss
  alertGit:
    Type: String
    Label: ''
    Default: ''
    AssociationProperty: Alert
    AssociationPropertyMetadata:
      ShowLabel: false
      Type: warning
      ShowIcon: true
      Title:
        zh-cn: 发布时，Git仓库代码会在脚本执行前被自动下载到工作目录下的code_deploy_application文件夹，脚本中无需做git clone相关操作。code_deploy_application文件夹会自动创建，如果已存在会被覆盖。
        en: When publishing, the code will be automatically downloaded to the working directory under the code_deploy_application folder, and the script does not need to perform the git clone related operation. The code_deploy_application folder will be automatically created, and it will be overwritten if it already exists.
      Visible:
        Condition:
          Fn::Equals:
            - ${revisionType}
            - GitRepo
  workingDir:
    Label:
      en: WorkingDir
      zh-cn: 工作目录
    Type: String
    Default: '/root/deploy'
    AllowedPattern: '^\/'
    Description:
      en: 1) The working directory of the application, <strong>please fill in the absolute path</strong>. <br>2) You can fill in a non-existent directory, and it will be automatically created when executed.
      zh-cn: 1) 应用的启动/停止脚本会以该目录作为执行的工作目录，<strong>请填写绝对路径</strong>。<br>2) 您可以填写尚不存在的目录，执行时会自动创建。
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${revisionType}
              - EcsImage
      Required:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${revisionType}
              - EcsImage
  applicationStart:
    Label:
      en: applicationStartScript
      zh-cn: 应用启动脚本
    Description:
      en: Attention-- <br>1) The deployment process follows the principle of "stop first and then start". Each deployment will first execute the stop script to ensure that the last deployed application is stopped normally, and then execute the startup script. <br>If you really do not need to stop application-related operations, you can leave the stop script blank and it will be skipped during deployment. <br>2) only support shell script
      zh-cn: 注意-- <br>1) 部署流程遵循“先停后启”的原则。每次部署都会先执行停止脚本，确保上一次部署的应用版本被正常停止，再执行启动脚本。<br>如果确实不需要停止应用相关操作，可将停止脚本置空，部署时会跳过。 <br>2) 仅支持shell脚本
    Type: String
    MaxLength: 16384
    AssociationProperty: ALIYUN::OOS::Command::CommandContent
    Default: ''
    AssociationPropertyMetadata:
      CommandType: RunShellScript
      ShowFullScreen: true
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${revisionType}
              - EcsImage
      Required:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${revisionType}
              - EcsImage
      Value:
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - Command
          Value: |-
            ### 启动应用
            ### Start the application
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - DockerImage
          Value: |-
            ### 启动当前版本的容器
            ### Start the current version of the container
            
            start_application() {
            #   image_name="myapp:latest"
            #   container_name="my-container"
            #   docker run -d -p 8080:8080 --name ${container_name} ${image_name}
            echo "== Finish Start Application =="
            }
            
            start_application
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - GitRepo
          Value: |-
            ### 启动当前版本的应用
            ### Start the current version of the application    
            
            start_application() {
            #  cd ./code_deploy_application
            #  java -jar sample-spring-1.0-SNAPSHOT.jar &
            echo "== Finish Start Application =="
            }
            
            start_application
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - Oss
          Value: |-            
            ### 启动当前版本的应用
            ### Start the current version of the application
            
            start_application() {
            #   java -jar ./sample-spring-1.0-SNAPSHOT.jar &
            echo "== Finish Start Application =="
            }
            
            start_application
  applicationStop:
    Label:
      en: applicationStopScript
      zh-cn: 应用停止脚本
    Description:
      en: <br>1)When no application is running, the stop script should be able to execute normally and exit without reporting an error. <br>2)only support shell script
      zh-cn: <br>1)当没有应用在运行时，停止脚本也应能正常执行完退出且不报错。<br>2)仅支持shell脚本
    Type: String
    MaxLength: 16384
    AssociationProperty: ALIYUN::OOS::Command::CommandContent
    Default: ''
    AssociationPropertyMetadata:
      CommandType: RunShellScript
      ShowFullScreen: true
      Visible:
        Condition:
          Fn::Not:
            Fn::Equals:
              - ${revisionType}
              - EcsImage
      Value:
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - Command
          Value: |-
            ### 停止应用
            ### Stop the application
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - DockerImage
          Value: |-
            ### 停止容器（如果有）
            ### Stop the container (if any)
            
            stop_application() {
            #   container_name="my-container"
            #   docker rm -f ${container_name} || true
            echo "== Finish Stop Application =="
            }
            
            stop_application
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - GitRepo
          Value: |-            
            ### 停止应用（如果有）
            ### Stop the application (if any)
            
            stop_application() {
            #   PID=$(ps -ef | grep "sample-spring-1.0-SNAPSHOT.jar" | grep -v "grep" | awk '{print $2}')
            #   if [ -n "$PID" ]; then
            #     kill -9 $PID
            #   fi
            echo "== Finish Stop Application =="
            }
            
            stop_application
        - Condition:
            Fn::Equals:
              - ${revisionType}
              - Oss
          Value: |-
            ### 停止应用（如果有）
            ### Stop the application (if any)
            stop_application() {
            #   PID=$(ps -ef | grep "sample-spring-1.0-SNAPSHOT.jar" | grep -v "grep" | awk '{print $2}')
            #   if [ -n "$PID" ]; then
            #     kill -9 $PID
            #   fi
            echo "== Finish Stop Application =="
            }
            
            stop_application
Tasks:
  - Name: CodeDeployConsole
    Action: ACS::Sleep
    Properties:
      Duration: 10s
Metadata:
  ALIYUN::OOS::Interface:
    ParameterGroups:
      - Parameters:
          - description
        Label:
          default:
            zh-cn: 版本描述
            en: Version Description
      - Parameters:
          - revisionType
          - regionIdOSS
          - bucketName
          - objectName
          - versionId
          - isInternalOSS
          - platform
          - owner
          - organization
          - repository
          - branch
          - commitId
          - imageId
          - acrType
          - acrRegion
          - acrId
          - namespace
          - repoName
          - imageVersion
          - isInternalAcr
        Label:
          default:
            zh-cn: 部署物源
            en: Deployment Source
      - Parameters:
          - alertDockerImage
          - alertGit
          - alertOss
          - workingDir
          - applicationStart
          - applicationStop
        Label:
          default:
            zh-cn: 启动/停止脚本
            en: Start/Stop Script
