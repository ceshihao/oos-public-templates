FormatVersion: OOS-2019-06-01
Description:
    en: Tag the resources it manages through resource management.
    zh-cn: 通过资源管理给其管理的资源打标签。
    name-en: ACS-TAG-TagResources
    name-zh-cn: 通过资源管理给资源打标签
    categories:
      - security
Parameters:
  regionId:
    Description:
      name-en: The id of region.
      name-zh-cn: 地域ID。
    Type: String
    Default: '{{ ACS::RegionId }}'
  resourceIds:
    Description:
      name-en: The resource ids.
      name-zh-cn: 资源ID。
    Type: List
  resourceType:
    Description:
      name-en: The resource type.
      name-zh-cn: 资源类型。
    Type: String
    AllowedValues:
      - ALIYUN::ECS::INSTANCE
      - ALIYUN::ECS::DISK
      - ALIYUN::ECS::SNAPSHOT
      - ALIYUN::ECS::IMAGE
      - ALIYUN::ECS::SECURITYGROUP
      - ALIYUN::ECS::VOLUME
      - ALIYUN::ECS::ENI
      - ALIYUN::ECS::DDH
      - ALIYUN::ECS::KEYPAIR
      - ALIYUN::ECS::LAUNCHTEMPLATE
      - ALIYUN::ECS::SNAPSHOTPOLICY
      - ALIYUN::ECS::DDHCLUSTER
      - ALIYUN::VPC::VPC
      - ALIYUN::VPC::VSWITCH
      - ALIYUN::VPC::ROUTETABLE
      - ALIYUN::VPC::EIP
      - ALIYUN::VPC::COMMONBANDWIDTHPACKAGE
      - ALIYUN::VPC::NATGATEWAY
      - ALIYUN::VPC::IPV6GATEWAY
      - ALIYUN::VPC::IPV6INSTANCE
      - ALIYUN::VPC::VPNGATEWAY
      - ALIYUN::VPC::IPV6BANDWIDTH
      - ALIYUN::SLB::INSTANCE
      - ALIYUN::SLB::ACL
      - ALIYUN::SLB::CERTIFICATE
      - ALIYUN::RDS::INSTANCE
      - ALIYUN::APIGATEWAY::APP
      - ALIYUN::APIGATEWAY::APIGROUP
      - ALIYUN::APIGATEWAY::PLUGIN
      - ALIYUN::APIGATEWAY::INSTANCE
      - ALIYUN::APIGATEWAY::API
      - ALIYUN::ALIKAFKA::INSTANCE
      - ALIYUN::ALIKAFKA::TOPIC
      - ALIYUN::ALIKAFKA::CONSUMERGROUP
      - ALIYUN::ROS::STACK
      - ALIYUN::ROS::TEMPLATE
      - ALIYUN::ALIDNS::DOMAIN
      - ALIYUN::ESS::SCALINGGROUP
      - ALIYUN::SMC::SOURCESERVER
      - ALIYUN::SMC::REPLICATIONJOB
      - ALIYUN::POLARDB::CLUSTER
      - ALIYUN::KVSTORE::INSTANCE
      - ALIYUN::DDS::INSTANCE
      - ALIYUN::CAS::INSTANCE
      - ALIYUN::BASTIONHOST::INSTANCE
      - ALIYUN::ELASTICSEARCH::INSTANCE
      - ALIYUN::OSS::BUCKET
      - ALIYUN::DDOSCOO::INSTANCE
      - ALIYUN::DDOSBGP::INSTANCE
      - ALIYUN::DRDS::INSTANCE
      - ALIYUN::GPDB::INSTANCE
      - ALIYUN::CEN::CEN
      - ALIYUN::BAAS::ORGANIZATION
      - ALIYUN::BAAS::CONSORTIUM
      - ALIYUN::ADB::CLUSTER
      - ALIYUN::HCS_SGW::GATEWAY
      - ALIYUN::IMAGESEARCH::INSTANCE
      - ALIYUN::CDN::DOMAIN
      - ALIYUN::OOS::TEMPLATE
      - ALIYUN::OOS::EXECUTION
      - ALIYUN::MULTIMOD::CLUSTER
      - ALIYUN::DBAUDIT::INSTANCE
      - ALIYUN::CS::CLUSTER
  tags:
    Description:
      name-en: The resource tag(example:{"k1":"v1","k2":"v2"}).
      name-zh-cn: 资源标签（例：{"k1":"v1","k2":"v2"}）。
    Type: Json
    Default: {"oosGenerate":"oosGenerate"}
  rateControl:
    Description:
      name-en: Concurrency ratio of task execution.
      name-zh-cn: 任务执行的并发比率。
    Type: Json
    AssociationProperty: RateControl
    Default:
      Mode: Concurrency
      MaxErrors: 0
      Concurrency: 10
  OOSAssumeRole:
    Description:
      name-en: The RAM role to be assumed by OOS.
      name-zh-cn: OOS扮演的RAM角色。
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
  - Name: tagResource
    Action: ACS::CheckFor
    Description:
      name-en: Tag the resources it manages through resource management.
      name-zh-cn: 通过资源管理给其管理的资源打标签。
    Properties:
      Service: TAG
      API: TagResources
      Parameters:
        RegionId: '{{ regionId }}'
        ResourceARN:
          - 'Fn::Jq':
              - First
              - '.resourceType | ascii_downcase |split("::") | "arn:acs:"+.[1]+":{{ regionId }}:{{ ACS::AccountId }}:"+.[2]+"/{{ ACS::TaskLoopItem }}"'
              - '{"resourceType":"{{resourceType}}"}'
        Tags: "{{ tags }}"
      DesiredValues:
        - null
      PropertySelector: .FailedResources.FailedResource[]
    Loop:
      Items: '{{ resourceIds }}'
      RateControl: '{{ rateControl }}'
      Outputs:
        errorMessages:
          AggregateType: 'Fn::ListJoin'
          AggregateField: errorMessage
    Outputs:
      errorMessage:
        Type: String
        ValueSelector: .FailedResources.FailedResource[]
  - Name: listTagResources
    Action: ACS::ExecuteAPI
    Description:
      name-en: Query the resource tags.
      name-zh-cn: 查询资源标签信息。
    Properties:
      Service: TAG
      API: ListTagResources
      Parameters:
        RegionId: '{{ regionId }}'
        ResourceARN:
          - 'Fn::Jq':
              - First
              - '.resourceType | ascii_downcase |split("::") | "arn:acs:"+.[1]+":{{ regionId }}:{{ ACS::AccountId }}:"+.[2]+"/{{ ACS::TaskLoopItem }}"'
              - '{"resourceType":"{{resourceType}}"}'
    Outputs:
      tagAndResourceId:
        Type: Json
        ValueSelector: .TagResources
    Loop:
      Items: '{{ resourceIds }}'
      RateControl: '{{ rateControl }}'
      Outputs:
        tagAndResourceIds:
          AggregateType: Fn::ListJoin
          AggregateField: tagAndResourceId
Outputs:
  resourceIdsAndTag:
    Type: List
    Value:
      'Fn::If':
        - 'Fn::Equals':
            - []
            - 'Fn::MergeList': '{{ tagResource.errorMessages }}'
        - '{{ listTagResources.tagAndResourceIds }}'
        - errcode: '{{ tagResource.errorMessages }}'
          results: '{{ listTagResources.tagAndResourceIds }}'

