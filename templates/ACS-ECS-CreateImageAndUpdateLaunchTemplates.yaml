FormatVersion: OOS-2019-06-01
Description:
  name-en:  ACS-ECS-CreateImageAndUpdateLaunchTemplates
  name-zh-cn: 创建ECS镜像并更新启动模版
  en: Creates an ECS image and update launch template
  zh-cn: 创建ECS镜像并更新启动模版
  categories:
    - image_manage
Parameters:
  regionId:
    Type: String
    Description:
      en: The id of region
      zh-cn: 地域ID
    AssociationProperty: RegionId
    Default: '{{ ACS::RegionId }}'
  instanceId:
    Description:
      en: The id of ECS instance
      zh-cn: ECS实例ID
    Type: String
  targetImageName:
    Description:
      en: The name of new image
      zh-cn: 新镜像的名称
    Type: String
    MinLength: 1
    AllowedPattern: '[A-Za-z0-9\_\-\:\{\}\.]*'
    Default: CreateImage_from_{{instanceId}}
  launchTemplateNames:
    Description:
      en: The name list of the instance launchTemplate to be updated.Must correspond to the selected region
      zh-cn: 待更新的实例启动模版名称列表，必须要与所选的地域对应
    Type: List
    Default: []
  tags:
    Description:
      en: The image tag
      zh-cn: 镜像标签
    Type: Json
    AssociationProperty: Tags
    AssociationPropertyMetadata:
      ShowSystem: false
    Default: []
  deleteSourceTemplateVersion:
    Description:
      en: delete launch template source version or not,the default is true
      zh-cn: 删除启动模版的原版本，默认为是
    Type: Boolean
    Default: true
    AllowedValues:
      - false
      - true
  rateControl:
    Description:
      en: Concurrency ratio of task execution
      zh-cn: 任务执行的并发比率
    Type: Json
    AssociationProperty: RateControl
    Default:
      Mode: Concurrency
      MaxErrors: 0
      Concurrency: 5
  OOSAssumeRole:
    Description:
      en: The RAM role to be assumed by OOS
      zh-cn: OOS扮演的RAM角色
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
- Name: createImage
  Action: 'ACS::ECS::CreateImage'
  Description:
    en: Create new image with the specified image name and instance ID
    zh-cn: 通过指定实例ID和镜像名称创建新的镜像
  Properties:
    regionId: '{{ regionId }}'
    instanceId: '{{ instanceId }}'
    imageName: '{{ targetImageName }}_on_{{ ACS::ExecutionId }}_at_{{ Acs::CurrentDate }}'
    tags: '{{tags}}'
  Outputs:
    imageId:
      ValueSelector: imageId
      Type: String
- Name: updateLaunchTemplate
  Action: 'ACS::ECS::UpdateLaunchTemplate'
  Description:
    en: Update instance launch template
    zh-cn: 更新实例启动模版
  Properties:
    regionId: '{{ regionId }}'
    imageId: '{{ createImage.imageId }}'
    launchTemplateName: '{{ ACS::TaskLoopItem }}'
    deleteSourceTemplateVersion: '{{ deleteSourceTemplateVersion }}'
  Loop:
    Items: '{{ launchTemplateNames }}'
Outputs:
  imageIds:
    Type: List
    Value: '{{ createImage.imageId }}'

