FormatVersion: OOS-2019-06-01
Description:
  en: Set domain server certificate.
  zh-cn: 启用指定域名下证书功能。
  name-en: ACS-CDN-SetDomainServerCertificate
  name-zh-cn: 启用指定域名下证书功能
  categories:
    - security
Parameters:
  regionId:
    Description:
      name-en: The id of region.
      name-zh-cn: 地域ID。
    AssociationProperty: RegionId
    Type: String
    Default: '{{ ACS::RegionId }}'
  domainName:
    Description:
      name-en: The name of the CDN domain for which the certificate is enabled.
      name-zh-cn: 域名。
    Type: String
  serverCertificateStatus:
    Description:
      name-en: Specifies whether to enable the SSL certificate.
      name-zh-cn: HTTPS证书是否启用。
    Type: String
    AllowedValues:
      - 'on'
      - 'off'
    Default: 'on'
  certType:
    Description:
      name-en: The type of cert.
      name-zh-cn: 证书类型。当证书类型为cas时，PrivateKey无需传参。
    Type: String
    AllowedValues:
      - cas
      - free
      - upload
  certName:
    Description:
      name-en: The name of the certificate.
      name-zh-cn: 证书名称
    Type: String
  serverCertificate:
    Description:
      name-en: The content of the certificate. Specify the content of the certificate only if you enable the SSL certificate.
      name-zh-cn: 安全证书内容，不启用证书则无需输入，配置证书请输入证书内容。
    Type: String
    Default: ''
  privateKey:
    Description:
      name-en: The private key. Specify the private key only if you enable the SSL certificate.
      name-zh-cn: 私钥内容，不启用证书则无需输入，配置证书请输入私钥内容。
    Type: String
    Default: ''
  forceSet:
    Description:
      name-en: If you set the value to 1, the system does not check the certificate name for duplicates and overwrites the information of the existing certificate with the same name.
      name-zh-cn: 设置为1时，忽略证书名称重复的校验，覆盖原有同名证书信息。
    Type: String
    Default: 1
  OOSAssumeRole:
    Description:
      name-en: The RAM role to be assumed by OOS.
      name-zh-cn: OOS扮演的RAM角色。
    Type: String
    Default: OOSServiceRole
RamRole: '{{ OOSAssumeRole }}'
Tasks:
- Name: getDomainDetail
  Action: ACS::ExecuteApi
  Description:
    name-en: get domain detail.
    name-zh-cn: 获取域名详情。
  Properties:
    Service: CDN
    API: DescribeCdnDomainDetail
    Parameters:
      RegionId: '{{ regionId }}'
      DomainName: '{{ domainName }}'
  Outputs:
    serverCertificateStatus:
      Type: String
      ValueSelector: GetDomainDetailModel.ServerCertificateStatus
- Name: whetherDomainIsReady
  Action: 'ACS::Choice'
  Description:
    name-en: Choose next task by server eertificate status.
    name-zh-cn: 根据证书的状态选择下一个任务。
  Properties:
    DefaultTask: SetDomainServerCertificate
    Choices:
      - When:
          'Fn::Equals':
            - 'on'
            - '{{ getDomainDetail.serverCertificateStatus }}'
        NextTask: ACS::END
- Name: SetDomainServerCertificate
  Action: ACS::ExecuteApi
  Description:
    name-en: Set domain server certificate
    name-zh-cn: 设置指定域名下证书功能。
  Properties:
    Service: CDN
    API: SetDomainServerCertificate
    Parameters:
      RegionId: '{{ regionId }}'
      DomainName: '{{ domainName }}'
      ServerCertificateStatus: '{{ serverCertificateStatus }}'
      CertType: '{{ certType }}'
      ServerCertificate: '{{ serverCertificate }}'
      PrivateKey: '{{ privateKey }}'
      ForceSet: '{{ forceSet }}'

